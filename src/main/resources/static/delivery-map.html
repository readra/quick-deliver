<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹¤ì‹œê°„ ë°°ì†¡ ì§€ë„ - Quick Deliver</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <!-- Kakao Map APIëŠ” ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
            z-index: 1000;
        }

        .header h1 {
            font-size: 1.5em;
        }

        .header .controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .btn-header {
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-header:hover {
            background: white;
            color: #667eea;
        }

        .map-container {
            display: flex;
            height: calc(100vh - 70px);
        }

        #map {
            flex: 1;
            position: relative;
        }

        .sidebar {
            width: 350px;
            background: white;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            overflow-y: auto;
            z-index: 100;
        }

        .sidebar-header {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 2px solid #e5e7eb;
        }

        .sidebar-header h2 {
            font-size: 1.3em;
            color: #333;
            margin-bottom: 10px;
        }

        .filter-buttons {
            display: flex;
            gap: 8px;
        }

        .filter-btn {
            padding: 8px 12px;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.2s;
        }

        .filter-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .rider-list {
            padding: 15px;
        }

        .rider-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid #667eea;
        }

        .rider-card:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .rider-card.available {
            border-left-color: #10b981;
        }

        .rider-card.busy {
            border-left-color: #f59e0b;
        }

        .rider-card.offline {
            border-left-color: #6b7280;
            opacity: 0.6;
        }

        .rider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .rider-name {
            font-weight: 700;
            color: #333;
        }

        .rider-status {
            padding: 4px 10px;
            border-radius: 10px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .status-available { background: #d1fae5; color: #065f46; }
        .status-busy { background: #fef3c7; color: #92400e; }
        .status-offline { background: #e5e7eb; color: #4b5563; }

        .rider-info {
            font-size: 0.85em;
            color: #666;
        }

        .connection-status {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 10px 16px;
            border-radius: 8px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 100;
            background: white;
        }

        .connection-status.connected {
            background: #10b981;
            color: white;
        }

        .connection-status.disconnected {
            background: #ef4444;
            color: white;
        }

        .pulse {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: white;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 100;
        }

        .legend-title {
            font-weight: 700;
            margin-bottom: 10px;
            color: #333;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 6px 0;
            font-size: 0.9em;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        /* ì»¤ìŠ¤í…€ ë§ˆì»¤ ìŠ¤íƒ€ì¼ */
        .custom-marker {
            background: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .custom-marker:hover {
            transform: scale(1.2);
        }

        .marker-label {
            position: absolute;
            top: 45px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            font-weight: 600;
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ—ºï¸ ì‹¤ì‹œê°„ ë°°ì†¡ ì§€ë„</h1>
        <div class="controls">
            <button class="btn-header" onclick="window.location.href='/backoffice-dashboard.html'">â† ëŒ€ì‹œë³´ë“œ</button>
            <button class="btn-header" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>

    <div class="map-container">
        <div id="map">
            <div class="connection-status disconnected" id="connectionStatus">
                <div class="pulse"></div>
                <span>ì—°ê²° ì¤‘...</span>
            </div>

            <div class="legend">
                <div class="legend-title">ë²”ë¡€</div>
                <div class="legend-item">
                    <span style="font-size: 1.5em;">ğŸš´</span>
                    <span>ëŒ€ê¸° ì¤‘ì¸ ë¼ì´ë”</span>
                </div>
                <div class="legend-item">
                    <span style="font-size: 1.5em;">ğŸš´â€â™‚ï¸</span>
                    <span>ë°°ë‹¬ ì¤‘ì¸ ë¼ì´ë”</span>
                </div>
            </div>
        </div>

        <div class="sidebar">
            <div class="sidebar-header">
                <h2>ë¼ì´ë” ëª©ë¡</h2>
                <div class="filter-buttons">
                    <button class="filter-btn active" onclick="filterRiders('all')">ì „ì²´</button>
                    <button class="filter-btn" onclick="filterRiders('available')">ëŒ€ê¸°</button>
                    <button class="filter-btn" onclick="filterRiders('busy')">ë°°ë‹¬ì¤‘</button>
                </div>
            </div>
            <div class="rider-list" id="riderList">
                <div class="empty-state">
                    <p>ë¼ì´ë” ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8080/api';
        const WS_URL = 'http://localhost:8080/ws';

        let map = null;
        let stompClient = null;
        let ridersData = new Map();
        let markers = new Map(); // ë¼ì´ë”ë³„ ë§ˆì»¤ ì €ì¥
        let currentFilter = 'all';
        let selectedRider = null;

        // ì¸ì¦ í™•ì¸
        function checkAuth() {
            const token = localStorage.getItem('jwt_token');
            const userInfo = localStorage.getItem('user_info');

            if (!token || !userInfo) {
                window.location.href = '/login.html';
                return null;
            }

            return { token, user: JSON.parse(userInfo) };
        }

        // ë¡œê·¸ì•„ì›ƒ
        function logout() {
            if (stompClient) {
                stompClient.disconnect();
            }
            localStorage.removeItem('jwt_token');
            localStorage.removeItem('user_info');
            window.location.href = '/login.html';
        }

        // API í˜¸ì¶œ
        async function apiCall(endpoint, method = 'GET', body = null) {
            const auth = checkAuth();
            if (!auth) return null;

            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${auth.token}`
                }
            };

            if (body) {
                options.body = JSON.stringify(body);
            }

            const response = await fetch(`${API_BASE_URL}${endpoint}`, options);

            if (response.status === 401) {
                logout();
                return null;
            }

            if (!response.ok) {
                throw new Error(`API í˜¸ì¶œ ì‹¤íŒ¨: ${response.status}`);
            }

            return await response.json();
        }

        // Kakao Map ì´ˆê¸°í™”
        function initMap() {
            const container = document.getElementById('map');
            const options = {
                center: new kakao.maps.LatLng(37.5665, 126.9780), // ì„œìš¸ì‹œì²­ ì¤‘ì‹¬
                level: 6 // í™•ëŒ€ ë ˆë²¨
            };

            map = new kakao.maps.Map(container, options);

            // ì§€ë„ íƒ€ì… ì»¨íŠ¸ë¡¤ ì¶”ê°€
            const mapTypeControl = new kakao.maps.MapTypeControl();
            map.addControl(mapTypeControl, kakao.maps.ControlPosition.TOPRIGHT);

            // ì¤Œ ì»¨íŠ¸ë¡¤ ì¶”ê°€
            const zoomControl = new kakao.maps.ZoomControl();
            map.addControl(zoomControl, kakao.maps.ControlPosition.RIGHT);

            console.log('Kakao Map ì´ˆê¸°í™” ì™„ë£Œ');
        }

        // ì»¤ìŠ¤í…€ ë§ˆì»¤ ìƒì„±
        function createCustomMarker(rider) {
            const icon = rider.status === 'BUSY' ? 'ğŸš´â€â™‚ï¸' : 'ğŸš´';

            // ì»¤ìŠ¤í…€ ì˜¤ë²„ë ˆì´ ë‚´ìš©
            const content = document.createElement('div');
            content.style.position = 'relative';
            content.innerHTML = `
                <div class="custom-marker">
                    ${icon}
                </div>
                <div class="marker-label">${rider.name}</div>
            `;

            return content;
        }

        // ë¼ì´ë” ë§ˆì»¤ ì—…ë°ì´íŠ¸
        function updateRiderMarker(rider) {
            if (!rider.latitude || !rider.longitude) {
                console.warn('ë¼ì´ë” ìœ„ì¹˜ ì •ë³´ ì—†ìŒ:', rider.riderId);
                return;
            }

            const position = new kakao.maps.LatLng(rider.latitude, rider.longitude);

            // ê¸°ì¡´ ë§ˆì»¤ê°€ ìˆìœ¼ë©´ ì œê±°
            if (markers.has(rider.riderId)) {
                markers.get(rider.riderId).setMap(null);
            }

            // ì»¤ìŠ¤í…€ ì˜¤ë²„ë ˆì´ë¡œ ë§ˆì»¤ ìƒì„±
            const customOverlay = new kakao.maps.CustomOverlay({
                position: position,
                content: createCustomMarker(rider),
                yAnchor: 1
            });

            customOverlay.setMap(map);
            markers.set(rider.riderId, customOverlay);

            // í´ë¦­ ì´ë²¤íŠ¸
            const markerElement = customOverlay.getContent();
            markerElement.onclick = () => {
                selectRider(rider.riderId);
            };
        }

        // ëª¨ë“  ë§ˆì»¤ ì—…ë°ì´íŠ¸
        function updateAllMarkers() {
            ridersData.forEach(rider => {
                updateRiderMarker(rider);
            });
        }

        // ë¼ì´ë” ë°ì´í„° ë¡œë“œ
        async function loadRiders() {
            try {
                const response = await apiCall('/riders/active');
                console.log('Map - Riders API ì‘ë‹µ:', response);

                // ApiResponse êµ¬ì¡° ì²˜ë¦¬
                const ridersArray = response?.data || response || [];
                console.log('Map - íŒŒì‹±ëœ ë¼ì´ë” ë°ì´í„°:', ridersArray);

                if (Array.isArray(ridersArray) && ridersArray.length > 0) {
                    ridersArray.forEach(rider => {
                        // currentLatitude, currentLongitude ì‚¬ìš©
                        const latitude = rider.currentLatitude;
                        const longitude = rider.currentLongitude;

                        ridersData.set(rider.riderId, {
                            ...rider,
                            latitude: latitude,
                            longitude: longitude
                        });
                    });

                    console.log('Map - ì €ì¥ëœ ë¼ì´ë” ë°ì´í„°:', Array.from(ridersData.values()));
                    renderRiderList();
                    updateAllMarkers();

                    // ì²« ë¡œë“œ ì‹œ ì§€ë„ ì¤‘ì‹¬ì„ ì²« ë²ˆì§¸ ë¼ì´ë”ë¡œ ì´ë™
                    if (ridersArray.length > 0) {
                        const firstRider = ridersArray[0];
                        if (firstRider.currentLatitude && firstRider.currentLongitude) {
                            const center = new kakao.maps.LatLng(
                                firstRider.currentLatitude,
                                firstRider.currentLongitude
                            );
                            map.setCenter(center);
                        }
                    }
                } else {
                    console.warn('Map - ë¼ì´ë” ë°ì´í„°ê°€ ë¹„ì–´ìˆê±°ë‚˜ ë°°ì—´ì´ ì•„ë‹™ë‹ˆë‹¤');
                }
            } catch (error) {
                console.error('ë¼ì´ë” ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ë¼ì´ë” ëª©ë¡ ë Œë”ë§
        function renderRiderList() {
            const container = document.getElementById('riderList');
            const riders = Array.from(ridersData.values());

            console.log('ë Œë”ë§í•  ë¼ì´ë”:', riders);

            // í•„í„°ë§
            const filtered = riders.filter(rider => {
                if (currentFilter === 'all') return true;
                if (currentFilter === 'available') return rider.status === 'AVAILABLE';
                if (currentFilter === 'busy') return rider.status === 'BUSY';
                return false;
            });

            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>í•´ë‹¹í•˜ëŠ” ë¼ì´ë”ê°€ ì—†ìŠµë‹ˆë‹¤</p></div>';
                return;
            }

            container.innerHTML = filtered.map(rider => `
                <div class="rider-card ${(rider.status || 'offline').toLowerCase()}"
                     onclick="selectRider('${rider.riderId}')">
                    <div class="rider-header">
                        <div class="rider-name">${rider.name || rider.riderId}</div>
                        <div class="rider-status status-${(rider.status || 'offline').toLowerCase()}">
                            ${getStatusText(rider.status)}
                        </div>
                    </div>
                    <div class="rider-info">
                        ğŸš— ${rider.vehicleType || 'N/A'} | â­ ${(rider.averageRating || 0).toFixed(1)}
                    </div>
                    ${rider.latitude && rider.longitude ?
                        `<div class="rider-info">ğŸ“ ${rider.latitude.toFixed(4)}, ${rider.longitude.toFixed(4)}</div>` :
                        '<div class="rider-info">ğŸ“ ìœ„ì¹˜ ì •ë³´ ì—†ìŒ</div>'}
                </div>
            `).join('');
        }

        // ë¼ì´ë” ì„ íƒ
        function selectRider(riderId) {
            selectedRider = riderId;
            const rider = ridersData.get(riderId);

            if (!rider || !rider.latitude || !rider.longitude) return;

            // ì§€ë„ ì¤‘ì‹¬ ì´ë™
            const position = new kakao.maps.LatLng(rider.latitude, rider.longitude);
            map.setCenter(position);
            map.setLevel(3); // í™•ëŒ€

            // ì¸í¬ìœˆë„ìš° í‘œì‹œ
            const infowindow = new kakao.maps.InfoWindow({
                content: `
                    <div style="padding:10px; min-width:150px;">
                        <div style="font-weight:700; margin-bottom:5px;">${rider.name || rider.riderId}</div>
                        <div style="font-size:0.9em; color:#666;">
                            ğŸš— ${rider.vehicleType || 'N/A'}<br>
                            â­ ${(rider.averageRating || 0).toFixed(1)}<br>
                            ğŸ“± ${rider.phoneNumber || 'N/A'}<br>
                            ìƒíƒœ: ${getStatusText(rider.status)}
                        </div>
                    </div>
                `,
                position: position
            });

            infowindow.open(map);

            // 3ì´ˆ í›„ ì¸í¬ìœˆë„ìš° ë‹«ê¸°
            setTimeout(() => {
                infowindow.close();
            }, 3000);
        }

        // í•„í„° ì ìš©
        function filterRiders(filter) {
            currentFilter = filter;

            // ë²„íŠ¼ í™œì„±í™”
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            renderRiderList();
        }

        // ìƒíƒœ í…ìŠ¤íŠ¸ ë³€í™˜
        function getStatusText(status) {
            const statusMap = {
                'AVAILABLE': 'ëŒ€ê¸°ì¤‘',
                'BUSY': 'ë°°ë‹¬ì¤‘',
                'OFFLINE': 'ì˜¤í”„ë¼ì¸'
            };
            return statusMap[status] || 'ì•Œ ìˆ˜ ì—†ìŒ';
        }

        // WebSocket ì—°ê²°
        function connectWebSocket() {
            const socket = new SockJS(WS_URL);
            stompClient = Stomp.over(socket);

            stompClient.connect({}, function(frame) {
                console.log('WebSocket ì—°ê²°ë¨:', frame);
                updateConnectionStatus(true);

                // ë¼ì´ë” ìœ„ì¹˜ êµ¬ë…
                stompClient.subscribe('/topic/monitoring/riders', function(message) {
                    const data = JSON.parse(message.body);
                    console.log('ìœ„ì¹˜ ì—…ë°ì´íŠ¸:', data);

                    // ë¼ì´ë” ìœ„ì¹˜ ì—…ë°ì´íŠ¸
                    const rider = ridersData.get(data.riderId);
                    if (rider) {
                        rider.latitude = data.latitude;
                        rider.longitude = data.longitude;
                        ridersData.set(data.riderId, rider);

                        // ë§ˆì»¤ ì—…ë°ì´íŠ¸
                        updateRiderMarker(rider);
                        renderRiderList();
                    }
                });

                // ë°°ì†¡ ìƒíƒœ êµ¬ë…
                stompClient.subscribe('/topic/monitoring/deliveries', function(message) {
                    loadRiders(); // ë°°ì†¡ ìƒíƒœ ë³€ê²½ ì‹œ ë¼ì´ë” ì •ë³´ ê°±ì‹ 
                });

            }, function(error) {
                console.error('WebSocket ì—°ê²° ì‹¤íŒ¨:', error);
                updateConnectionStatus(false);

                // ì¬ì—°ê²° ì‹œë„
                setTimeout(connectWebSocket, 5000);
            });
        }

        // ì—°ê²° ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateConnectionStatus(connected) {
            const statusDiv = document.getElementById('connectionStatus');
            if (connected) {
                statusDiv.className = 'connection-status connected';
                statusDiv.querySelector('span').textContent = 'ì‹¤ì‹œê°„ ì—°ê²°';
            } else {
                statusDiv.className = 'connection-status disconnected';
                statusDiv.querySelector('span').textContent = 'ì—°ê²° ëŠê¹€';
            }
        }

        // Kakao Map API ë™ì  ë¡œë“œ
        async function loadKakaoMapScript() {
            try {
                // ë°±ì—”ë“œì—ì„œ API í‚¤ ê°€ì ¸ì˜¤ê¸°
                const response = await fetch(`${API_BASE_URL}/config/map`);
                const config = await response.json();

                console.log('Map API ì„¤ì • ë¡œë“œ ì™„ë£Œ');

                // Kakao Map ìŠ¤í¬ë¦½íŠ¸ ë™ì  ë¡œë“œ
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.type = 'text/javascript';
                    script.src = `//dapi.kakao.com/v2/maps/sdk.js?appkey=${config.apiKey}&autoload=false`;
                    script.onload = () => {
                        console.log('Kakao Map ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì™„ë£Œ');
                        resolve();
                    };
                    script.onerror = () => {
                        reject(new Error('Kakao Map ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì‹¤íŒ¨'));
                    };
                    document.head.appendChild(script);
                });
            } catch (error) {
                console.error('API í‚¤ ë¡œë“œ ì‹¤íŒ¨:', error);
                throw error;
            }
        }

        // ì´ˆê¸°í™”
        window.addEventListener('DOMContentLoaded', async () => {
            const auth = checkAuth();
            if (!auth) return;

            try {
                // 1. Kakao Map API ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ
                await loadKakaoMapScript();

                // 2. Kakao Maps ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ
                kakao.maps.load(() => {
                    console.log('Kakao Maps ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì™„ë£Œ');

                    // 3. ì§€ë„ ì´ˆê¸°í™”
                    initMap();

                    // 4. ë°ì´í„° ë¡œë“œ
                    loadRiders();

                    // 5. WebSocket ì—°ê²°
                    connectWebSocket();

                    // 6. ì£¼ê¸°ì ìœ¼ë¡œ ë¼ì´ë” ì •ë³´ ê°±ì‹  (30ì´ˆë§ˆë‹¤)
                    setInterval(loadRiders, 30000);
                });
            } catch (error) {
                console.error('ì§€ë„ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                alert('ì§€ë„ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. API í‚¤ ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
            }
        });
    </script>
</body>
</html>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
            z-index: 1000;
        }

        .header h1 {
            font-size: 1.5em;
        }

        .header .controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .btn-header {
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-header:hover {
            background: white;
            color: #667eea;
        }

        .map-container {
            display: flex;
            height: calc(100vh - 70px);
        }

        .map-canvas {
            flex: 1;
            background: #e5e7eb;
            position: relative;
            overflow: hidden;
        }

        .sidebar {
            width: 350px;
            background: white;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            overflow-y: auto;
            z-index: 100;
        }

        .sidebar-header {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 2px solid #e5e7eb;
        }

        .sidebar-header h2 {
            font-size: 1.3em;
            color: #333;
            margin-bottom: 10px;
        }

        .filter-buttons {
            display: flex;
            gap: 8px;
        }

        .filter-btn {
            padding: 8px 12px;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.2s;
        }

        .filter-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .rider-list {
            padding: 15px;
        }

        .rider-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid #667eea;
        }

        .rider-card:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .rider-card.available {
            border-left-color: #10b981;
        }

        .rider-card.busy {
            border-left-color: #f59e0b;
        }

        .rider-card.offline {
            border-left-color: #6b7280;
            opacity: 0.6;
        }

        .rider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .rider-name {
            font-weight: 700;
            color: #333;
        }

        .rider-status {
            padding: 4px 10px;
            border-radius: 10px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .status-available { background: #d1fae5; color: #065f46; }
        .status-busy { background: #fef3c7; color: #92400e; }
        .status-offline { background: #e5e7eb; color: #4b5563; }

        .rider-info {
            font-size: 0.85em;
            color: #666;
        }

        /* ì§€ë„ ë§ˆì»¤ */
        .marker {
            position: absolute;
            transform: translate(-50%, -100%);
            cursor: pointer;
            transition: all 0.3s;
            z-index: 10;
        }

        .marker:hover {
            transform: translate(-50%, -100%) scale(1.2);
            z-index: 20;
        }

        .marker-icon {
            font-size: 2em;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }

        .marker-label {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            font-weight: 600;
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .marker.selected .marker-icon {
            animation: bounce 0.5s ease-in-out;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .marker-popup {
            position: absolute;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 200px;
            z-index: 1000;
            transform: translate(-50%, -120%);
        }

        .popup-header {
            font-weight: 700;
            color: #333;
            margin-bottom: 8px;
        }

        .popup-info {
            font-size: 0.9em;
            color: #666;
            margin: 4px 0;
        }

        .connection-status {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 10px 16px;
            border-radius: 8px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 100;
        }

        .connection-status.connected {
            background: #10b981;
            color: white;
        }

        .connection-status.disconnected {
            background: #ef4444;
            color: white;
        }

        .pulse {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: white;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 100;
        }

        .legend-title {
            font-weight: 700;
            margin-bottom: 10px;
            color: #333;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 6px 0;
            font-size: 0.9em;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        /* ì‹¤ì‹œê°„ ê·¸ë¦¬ë“œ ë°°ê²½ */
        .map-canvas::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                linear-gradient(rgba(0,0,0,0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0,0,0,0.05) 1px, transparent 1px);
            background-size: 50px 50px;
            z-index: 0;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ—ºï¸ ì‹¤ì‹œê°„ ë°°ì†¡ ì§€ë„</h1>
        <div class="controls">
            <button class="btn-header" onclick="window.location.href='/backoffice-dashboard.html'">â† ëŒ€ì‹œë³´ë“œ</button>
            <button class="btn-header" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>

    <div class="map-container">
        <div class="map-canvas" id="mapCanvas">
            <div class="connection-status disconnected" id="connectionStatus">
                <div class="pulse"></div>
                <span>ì—°ê²° ì¤‘...</span>
            </div>

            <div class="legend">
                <div class="legend-title">ë²”ë¡€</div>
                <div class="legend-item">
                    <span style="font-size: 1.5em;">ğŸš´</span>
                    <span>ëŒ€ê¸° ì¤‘ì¸ ë¼ì´ë”</span>
                </div>
                <div class="legend-item">
                    <span style="font-size: 1.5em;">ğŸš´â€â™‚ï¸</span>
                    <span>ë°°ë‹¬ ì¤‘ì¸ ë¼ì´ë”</span>
                </div>
                <div class="legend-item">
                    <span style="font-size: 1.5em;">ğŸ“</span>
                    <span>ë°°ì†¡ ëª©ì ì§€</span>
                </div>
            </div>
        </div>

        <div class="sidebar">
            <div class="sidebar-header">
                <h2>ë¼ì´ë” ëª©ë¡</h2>
                <div class="filter-buttons">
                    <button class="filter-btn active" onclick="filterRiders('all')">ì „ì²´</button>
                    <button class="filter-btn" onclick="filterRiders('available')">ëŒ€ê¸°</button>
                    <button class="filter-btn" onclick="filterRiders('busy')">ë°°ë‹¬ì¤‘</button>
                </div>
            </div>
            <div class="rider-list" id="riderList">
                <div class="empty-state">
                    <p>ë¼ì´ë” ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8080/api';
        const WS_URL = 'http://localhost:8080/ws';
        
        let stompClient = null;
        let ridersData = new Map();
        let currentFilter = 'all';
        let selectedRider = null;

        // ì¸ì¦ í™•ì¸
        function checkAuth() {
            const token = localStorage.getItem('jwt_token');
            const userInfo = localStorage.getItem('user_info');
            
            if (!token || !userInfo) {
                window.location.href = '/login.html';
                return null;
            }

            return { token, user: JSON.parse(userInfo) };
        }

        // ë¡œê·¸ì•„ì›ƒ
        function logout() {
            if (stompClient) {
                stompClient.disconnect();
            }
            localStorage.removeItem('jwt_token');
            localStorage.removeItem('user_info');
            window.location.href = '/login.html';
        }

        // API í˜¸ì¶œ
        async function apiCall(endpoint, method = 'GET', body = null) {
            const auth = checkAuth();
            if (!auth) return null;

            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${auth.token}`
                }
            };

            if (body) {
                options.body = JSON.stringify(body);
            }

            const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
            
            if (response.status === 401) {
                logout();
                return null;
            }

            if (!response.ok) {
                throw new Error(`API í˜¸ì¶œ ì‹¤íŒ¨: ${response.status}`);
            }

            return await response.json();
        }

        // ë¼ì´ë” ë°ì´í„° ë¡œë“œ
        async function loadRiders() {
            try {
                const response = await apiCall('/riders/active');
                console.log('Map - Riders API ì‘ë‹µ:', response);

                // ApiResponse êµ¬ì¡° ì²˜ë¦¬
                const ridersArray = response?.data || response || [];
                console.log('Map - íŒŒì‹±ëœ ë¼ì´ë” ë°ì´í„°:', ridersArray);

                if (Array.isArray(ridersArray) && ridersArray.length > 0) {
                    ridersArray.forEach(rider => {
                        // ê¸°ì¡´ ìœ„ì¹˜ ì •ë³´ ìœ ì§€ ë˜ëŠ” API ì‘ë‹µì˜ ìœ„ì¹˜ ì‚¬ìš©
                        const existing = ridersData.get(rider.riderId);

                        // currentLatitude, currentLongitude í•„ë“œ ì‚¬ìš©
                        const latitude = rider.currentLatitude || (existing && existing.latitude);
                        const longitude = rider.currentLongitude || (existing && existing.longitude);

                        ridersData.set(rider.riderId, {
                            ...rider,
                            latitude: latitude,
                            longitude: longitude
                        });
                    });

                    console.log('Map - ì €ì¥ëœ ë¼ì´ë” ë°ì´í„°:', Array.from(ridersData.values()));
                    renderRiderList();
                    renderMap();
                } else {
                    console.warn('Map - ë¼ì´ë” ë°ì´í„°ê°€ ë¹„ì–´ìˆê±°ë‚˜ ë°°ì—´ì´ ì•„ë‹™ë‹ˆë‹¤');
                }
            } catch (error) {
                console.error('ë¼ì´ë” ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ë¼ì´ë” ëª©ë¡ ë Œë”ë§
        function renderRiderList() {
            const container = document.getElementById('riderList');
            const riders = Array.from(ridersData.values());
            
            console.log('ë Œë”ë§í•  ë¼ì´ë”:', riders);

            // í•„í„°ë§
            const filtered = riders.filter(rider => {
                if (currentFilter === 'all') return true;
                if (currentFilter === 'available') return rider.status === 'AVAILABLE';
                if (currentFilter === 'busy') return rider.status === 'BUSY';
                return false;
            });

            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>í•´ë‹¹í•˜ëŠ” ë¼ì´ë”ê°€ ì—†ìŠµë‹ˆë‹¤</p></div>';
                return;
            }

            container.innerHTML = filtered.map(rider => `
                <div class="rider-card ${(rider.status || 'offline').toLowerCase()}"
                     onclick="selectRider('${rider.riderId}')">
                    <div class="rider-header">
                        <div class="rider-name">${rider.name || rider.riderId}</div>
                        <div class="rider-status status-${(rider.status || 'offline').toLowerCase()}">
                            ${getStatusText(rider.status)}
                        </div>
                    </div>
                    <div class="rider-info">
                        ğŸš— ${rider.vehicleType || 'N/A'} | â­ ${(rider.averageRating || 0).toFixed(1)}
                    </div>
                    ${rider.latitude && rider.longitude ? 
                        `<div class="rider-info">ğŸ“ ìœ„ì¹˜: ${rider.latitude.toFixed(4)}, ${rider.longitude.toFixed(4)}</div>` : 
                        '<div class="rider-info">ğŸ“ ìœ„ì¹˜ ì •ë³´ ì—†ìŒ</div>'}
                </div>
            `).join('');
        }

        // ì§€ë„ ë Œë”ë§ (ì‹œë®¬ë ˆì´ì…˜)
        function renderMap() {
            const mapCanvas = document.getElementById('mapCanvas');
            
            // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
            const existingMarkers = mapCanvas.querySelectorAll('.marker, .marker-popup');
            existingMarkers.forEach(marker => marker.remove());

            const riders = Array.from(ridersData.values());
            const width = mapCanvas.clientWidth;
            const height = mapCanvas.clientHeight;

            riders.forEach((rider, index) => {
                // ìœ„ì¹˜ê°€ ì—†ìœ¼ë©´ ëœë¤ ìƒì„± (ì‹œë®¬ë ˆì´ì…˜)
                if (!rider.latitude || !rider.longitude) {
                    rider.latitude = 37.5 + (Math.random() * 0.1);
                    rider.longitude = 126.9 + (Math.random() * 0.1);
                }

                // ì¢Œí‘œë¥¼ í™”ë©´ ì¢Œí‘œë¡œ ë³€í™˜ (ê°„ë‹¨í•œ ë§¤í•‘)
                const x = ((rider.longitude - 126.85) / 0.2) * width;
                const y = ((37.6 - rider.latitude) / 0.2) * height;

                // ë§ˆì»¤ ìƒì„±
                const marker = document.createElement('div');
                marker.className = 'marker';
                marker.style.left = `${x}px`;
                marker.style.top = `${y}px`;
                marker.dataset.riderId = rider.riderId;

                const icon = rider.status === 'BUSY' ? 'ğŸš´â€â™‚ï¸' : 'ğŸš´';
                marker.innerHTML = `
                    <div class="marker-icon">${icon}</div>
                    <div class="marker-label">${rider.name || rider.riderId}</div>
                `;

                marker.onclick = () => selectRider(rider.riderId);
                mapCanvas.appendChild(marker);
            });
        }

        // ë¼ì´ë” ì„ íƒ
        function selectRider(riderId) {
            selectedRider = riderId;
            const rider = ridersData.get(riderId);
            
            if (!rider) return;

            // ê¸°ì¡´ íŒì—… ì œê±°
            document.querySelectorAll('.marker-popup').forEach(p => p.remove());
            document.querySelectorAll('.marker.selected').forEach(m => m.classList.remove('selected'));

            // ë§ˆì»¤ ì„ íƒ í‘œì‹œ
            const marker = document.querySelector(`[data-rider-id="${riderId}"]`);
            if (marker) {
                marker.classList.add('selected');
                
                // íŒì—… ìƒì„±
                const popup = document.createElement('div');
                popup.className = 'marker-popup';
                popup.style.left = marker.style.left;
                popup.style.top = marker.style.top;
                popup.innerHTML = `
                    <div class="popup-header">${rider.name || rider.riderId}</div>
                    <div class="popup-info">ğŸš— ${rider.vehicleType || 'N/A'}</div>
                    <div class="popup-info">â­ í‰ì : ${(rider.averageRating || 0).toFixed(1)}</div>
                    <div class="popup-info">ğŸ“± ${rider.phoneNumber || 'N/A'}</div>
                    <div class="popup-info">ğŸ“ ${rider.latitude?.toFixed(4)}, ${rider.longitude?.toFixed(4)}</div>
                    <div class="popup-info">ìƒíƒœ: ${getStatusText(rider.status)}</div>
                `;
                
                document.getElementById('mapCanvas').appendChild(popup);

                // 3ì´ˆ í›„ íŒì—… ì œê±°
                setTimeout(() => {
                    popup.remove();
                    marker.classList.remove('selected');
                }, 3000);
            }
        }

        // í•„í„° ì ìš©
        function filterRiders(filter) {
            currentFilter = filter;
            
            // ë²„íŠ¼ í™œì„±í™”
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            renderRiderList();
        }

        // ìƒíƒœ í…ìŠ¤íŠ¸ ë³€í™˜
        function getStatusText(status) {
            const statusMap = {
                'AVAILABLE': 'ëŒ€ê¸°ì¤‘',
                'BUSY': 'ë°°ë‹¬ì¤‘',
                'OFFLINE': 'ì˜¤í”„ë¼ì¸'
            };
            return statusMap[status] || 'ì•Œ ìˆ˜ ì—†ìŒ';
        }

        // WebSocket ì—°ê²°
        function connectWebSocket() {
            const socket = new SockJS(WS_URL);
            stompClient = Stomp.over(socket);
            
            stompClient.connect({}, function(frame) {
                console.log('WebSocket ì—°ê²°ë¨:', frame);
                updateConnectionStatus(true);

                // ë¼ì´ë” ìœ„ì¹˜ êµ¬ë…
                stompClient.subscribe('/topic/monitoring/riders', function(message) {
                    const data = JSON.parse(message.body);
                    
                    // ë¼ì´ë” ìœ„ì¹˜ ì—…ë°ì´íŠ¸
                    const rider = ridersData.get(data.riderId);
                    if (rider) {
                        rider.latitude = data.latitude;
                        rider.longitude = data.longitude;
                        ridersData.set(data.riderId, rider);
                        
                        renderRiderList();
                        renderMap();
                    }
                });

                // ë°°ì†¡ ìƒíƒœ êµ¬ë…
                stompClient.subscribe('/topic/monitoring/deliveries', function(message) {
                    loadRiders(); // ë°°ì†¡ ìƒíƒœ ë³€ê²½ ì‹œ ë¼ì´ë” ì •ë³´ ê°±ì‹ 
                });

            }, function(error) {
                console.error('WebSocket ì—°ê²° ì‹¤íŒ¨:', error);
                updateConnectionStatus(false);
                
                // ì¬ì—°ê²° ì‹œë„
                setTimeout(connectWebSocket, 5000);
            });
        }

        // ì—°ê²° ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateConnectionStatus(connected) {
            const statusDiv = document.getElementById('connectionStatus');
            if (connected) {
                statusDiv.className = 'connection-status connected';
                statusDiv.querySelector('span').textContent = 'ì‹¤ì‹œê°„ ì—°ê²°';
            } else {
                statusDiv.className = 'connection-status disconnected';
                statusDiv.querySelector('span').textContent = 'ì—°ê²° ëŠê¹€';
            }
        }

        // ìœˆë„ìš° ë¦¬ì‚¬ì´ì¦ˆ ì‹œ ì§€ë„ ì¬ë Œë”ë§
        window.addEventListener('resize', () => {
            renderMap();
        });

        // ì´ˆê¸°í™”
        window.addEventListener('DOMContentLoaded', async () => {
            const auth = checkAuth();
            if (!auth) return;

            await loadRiders();
            connectWebSocket();

            // ì£¼ê¸°ì ìœ¼ë¡œ ë¼ì´ë” ì •ë³´ ê°±ì‹ 
            setInterval(loadRiders, 30000);
        });
    </script>
</body>
</html>